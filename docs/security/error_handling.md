# Find My Rizz - 에러 핸들링 및 예외 처리

## 문서 정보

- **버전**: 1.0
- **작성일**: 2024-01-01
- **목적**: 모든 실패 시나리오에 대한 체계적 대응 방안 정의

---

## 목차

1. [에러 처리 원칙](#1-에러-처리-원칙)
2. [결제 단계 에러](#2-결제-단계-에러)
3. [이미지 업로드 에러](#3-이미지-업로드-에러)
4. [AI 생성 에러](#4-ai-생성-에러)
5. [리포트 생성 에러](#5-리포트-생성-에러)
6. [SMS 발송 에러](#6-sms-발송-에러)
7. [결과 조회 에러](#7-결과-조회-에러)
8. [시스템 에러](#8-시스템-에러)
9. [모니터링 및 알림](#9-모니터링-및-알림)

---

## 1. 에러 처리 원칙

### 1.1 기본 원칙

**사용자 중심:**

- 명확하고 이해하기 쉬운 에러 메시지
- 다음 행동 안내 (재시도, 고객센터 문의 등)
- 기술적 세부사항 숨김

**개발자 중심:**

- 상세한 에러 로그 저장
- 스택 트레이스 기록
- 에러 코드 체계화

**복구 가능성:**

- 자동 재시도 (멱등성 보장)
- 부분 실패 허용 (가능한 경우)
- 우아한 성능 저하 (Graceful Degradation)

### 1.2 에러 응답 형식

```json
{
  "success": false,
  "error": {
    "code": "E001",
    "message": "사용자에게 표시할 메시지",
    "details": {
      "field": "추가 정보"
    },
    "timestamp": "2024-01-01T12:00:00Z",
    "request_id": "req_abc123"
  }
}
```

### 1.3 에러 로깅

```python
import logging
import json

logger.error(
    "Payment verification failed",
    extra={
        "error_code": "E002",
        "job_id": job_id,
        "merchant_uid": merchant_uid,
        "expected_amount": 9900,
        "received_amount": amount,
        "request_id": request_id
    }
)
```

---

## 2. 결제 단계 에러

### 2.1 결제 초기화 실패

**시나리오:**

- PortOne SDK 로드 실패
- 네트워크 오류
- 서버 응답 없음

**에러 코드:** `E-PAY-001`

**사용자 메시지:**

```
결제창을 불러오는 중 오류가 발생했습니다.
페이지를 새로고침하거나 잠시 후 다시 시도해주세요.
```

**처리 방안:**

1. 프론트엔드: 3초 후 자동 재시도
2. 재시도 3회 실패 시 에러 페이지 표시
3. 백엔드: Job 생성 롤백

**로그:**

```json
{
  "level": "ERROR",
  "code": "E-PAY-001",
  "message": "Payment initialization failed",
  "user_phone": "010****5678",
  "error": "Network timeout"
}
```

---

### 2.2 결제 금액 불일치

**시나리오:**

- 클라이언트에서 금액 변조 시도
- PortOne 응답 금액 불일치

**에러 코드:** `E-PAY-002`

**사용자 메시지:**

```
결제 금액이 일치하지 않습니다.
고객센터로 문의해주세요.
```

**처리 방안:**

1. 결제 즉시 취소
2. payment_failures 테이블에 로그 저장
3. 관리자 알림 (Slack/Email)
4. IP 주소 기록 (부정 사용 추적)

**로그:**

```json
{
  "level": "CRITICAL",
  "code": "E-PAY-002",
  "message": "Payment amount mismatch",
  "expected": 9900,
  "received": 10000,
  "merchant_uid": "FMR_20240101_123456",
  "ip_address": "123.456.789.0"
}
```

---

### 2.3 결제 검증 실패

**시나리오:**

- PortOne API 응답 없음
- 서명 검증 실패
- 결제 상태 불명확

**에러 코드:** `E-PAY-003`

**사용자 메시지:**

```
결제 확인 중입니다.
잠시만 기다려주세요. (최대 5분)
```

**처리 방안:**

1. 5분 간격으로 PortOne API 재조회 (최대 3회)
2. 3회 실패 시 관리자 수동 확인 필요
3. 사용자에게 "확인 중" 상태 표시
4. 확인 완료 시 SMS 발송

**재시도 로직:**

```python
@retry(
    stop=stop_after_attempt(3),
    wait=wait_exponential(multiplier=1, min=60, max=300),
    retry=retry_if_exception_type(PortOneAPIError)
)
async def verify_payment(imp_uid: str):
    response = await portone_client.get_payment(imp_uid)
    return response
```

---

### 2.4 결제 취소/환불 실패

**시나리오:**

- 사용자 환불 요청
- PortOne API 오류

**에러 코드:** `E-PAY-004`

**사용자 메시지:**

```
환불 처리 중 오류가 발생했습니다.
고객센터로 문의해주세요.
```

**처리 방안:**

1. 환불 요청 큐에 저장
2. 관리자 수동 처리
3. 처리 완료 시 사용자 알림

---

## 3. 이미지 업로드 에러

### 3.1 파일 형식 오류

**시나리오:**

- JPEG/PNG 외 형식 업로드
- 손상된 파일

**에러 코드:** `E-IMG-001`

**사용자 메시지:**

```
지원하지 않는 파일 형식입니다.
JPEG 또는 PNG 파일을 업로드해주세요.
```

**처리 방안:**

1. 프론트엔드: 파일 선택 시 형식 제한
2. 백엔드: MIME 타입 + Magic Number 검증
3. 업로드 거부

**검증 코드:**

```python
import magic

def validate_image(file: UploadFile):
    # MIME 타입 검증
    if file.content_type not in ['image/jpeg', 'image/png']:
        raise HTTPException(400, "E-IMG-001: Invalid file type")

    # Magic Number 검증
    file_content = await file.read()
    mime = magic.from_buffer(file_content, mime=True)
    if mime not in ['image/jpeg', 'image/png']:
        raise HTTPException(400, "E-IMG-001: Invalid file type")
```

---

### 3.2 파일 크기 초과

**시나리오:**

- 10MB 초과 파일 업로드

**에러 코드:** `E-IMG-002`

**사용자 메시지:**

```
파일 크기가 너무 큽니다. (최대 10MB)
이미지를 압축하거나 다른 사진을 선택해주세요.
```

**처리 방안:**

1. 프론트엔드: 업로드 전 크기 체크
2. 백엔드: Content-Length 헤더 검증
3. 압축 가이드 제공

---

### 3.3 얼굴 감지 실패

**시나리오:**

- 얼굴이 없는 이미지
- 여러 얼굴 감지
- 측면 얼굴

**에러 코드:** `E-IMG-003`

**사용자 메시지:**

```
얼굴을 감지할 수 없습니다.
정면을 향한 얼굴 사진을 업로드해주세요.
```

**처리 방안:**

1. 경고 표시 후 계속 진행 허용 (선택사항)
2. 사진 가이드 재안내
3. 로그 저장 (품질 개선용)

---

### 3.4 S3 업로드 실패

**시나리오:**

- 네트워크 오류
- S3 서비스 장애
- 권한 오류

**에러 코드:** `E-IMG-004`

**사용자 메시지:**

```
이미지 업로드 중 오류가 발생했습니다.
잠시 후 다시 시도해주세요.
```

**처리 방안:**

1. 3회 재시도 (지수 백오프)
2. 재시도 실패 시 에러 반환
3. Job 상태 유지 (pending_upload)
4. 사용자 재업로드 가능

**재시도 로직:**

```python
@retry(
    stop=stop_after_attempt(3),
    wait=wait_exponential(multiplier=1, min=2, max=10),
    retry=retry_if_exception_type(S3Error)
)
async def upload_to_s3(file_content: bytes, s3_key: str):
    s3_client.put_object(
        Bucket=bucket_name,
        Key=s3_key,
        Body=file_content
    )
```

---

## 4. AI 생성 에러

### 4.1 Replicate API 호출 실패

**시나리오:**

- API 키 오류
- 네트워크 오류
- Rate Limit 초과

**에러 코드:** `E-AI-001`

**사용자 메시지:**

```
AI 이미지 생성을 시작하는 중 오류가 발생했습니다.
자동으로 재시도됩니다.
```

**처리 방안:**

1. 5분 간격으로 3회 재시도
2. 재시도 실패 시 Job 상태: failed
3. 사용자에게 SMS 발송 (실패 안내)
4. 환불 처리

**재시도 로직:**

```python
@retry(
    stop=stop_after_attempt(3),
    wait=wait_fixed(300),  # 5분
    retry=retry_if_exception_type(ReplicateAPIError)
)
async def generate_image(input_image_url: str):
    prediction = replicate.predictions.create(
        version="ai_image_generation_model_version",
        input={"image": input_image_url}
    )
    return prediction
```

---

### 4.2 생성 시간 초과

**시나리오:**

- 5분 이상 생성 중
- Replicate 서버 과부하

**에러 코드:** `E-AI-002`

**사용자 메시지:**

```
AI 이미지 생성이 지연되고 있습니다.
조금만 더 기다려주세요.
```

**처리 방안:**

1. 10분까지 대기
2. 10분 초과 시 실패 처리
3. 환불 처리
4. 관리자 알림

---

### 4.3 부적절한 콘텐츠 감지

**시나리오:**

- Replicate 안전 필터 작동
- 생성 결과 부적절

**에러 코드:** `E-AI-003`

**사용자 메시지:**

```
이미지 생성 중 오류가 발생했습니다.
다른 사진으로 다시 시도해주세요.
```

**처리 방안:**

1. 생성 중단
2. Job 상태: failed
3. 사용자에게 재업로드 안내
4. 환불 처리 (선택사항)

---

### 4.4 부분 생성 실패

**시나리오:**

- 3장 중 1-2장만 성공

**에러 코드:** `E-AI-004`

**사용자 메시지:**

```
일부 이미지 생성에 실패했습니다.
성공한 이미지로 결과를 제공합니다.
```

**처리 방안:**

1. 성공한 이미지만 저장
2. 실패한 이미지 재생성 시도 (1회)
3. 최소 2장 이상 성공 시 계속 진행
4. 1장 이하 성공 시 전체 실패 처리

---

## 5. 리포트 생성 에러

### 5.1 OpenAI API 호출 실패

**시나리오:**

- API 키 오류
- Rate Limit 초과
- 네트워크 오류

**에러 코드:** `E-RPT-001`

**사용자 메시지:**

```
리포트 생성 중 오류가 발생했습니다.
자동으로 재시도됩니다.
```

**처리 방안:**

1. 3회 재시도 (지수 백오프)
2. 재시도 실패 시 기본 템플릿 사용
3. 기본 템플릿: 일반적인 관리법 추천

**기본 템플릿:**

```json
{
  "summary": "체계적인 자기관리를 통해 전반적인 인상 개선이 가능합니다.",
  "improvements": [
    {
      "area": "피부 관리",
      "description": "기초 피부 관리 및 자외선 차단",
      "recommendations": ["SC003", "P007"]
    },
    {
      "area": "얼굴 윤곽",
      "description": "건강한 체중 관리",
      "recommendations": ["SC005"]
    }
  ]
}
```

---

### 5.2 관리법 매칭 실패

**시나리오:**

- knowledge_base 조회 실패
- 매칭 알고리즘 오류

**에러 코드:** `E-RPT-002`

**사용자 메시지:**

```
(사용자에게 표시 안 함)
```

**처리 방안:**

1. 기본 관리법 세트 사용
2. 로그 저장 (개선용)
3. 서비스 계속 진행

---

## 6. SMS 발송 에러

### 6.1 CoolSMS API 호출 실패

**시나리오:**

- API 키 오류
- 잔액 부족
- 네트워크 오류

**에러 코드:** `E-SMS-001`

**사용자 메시지:**

```
(SMS 발송 실패 시 사용자는 모름)
```

**처리 방안:**

1. 5분 간격으로 3회 재시도
2. 재시도 실패 시 관리자 알림
3. 관리자 수동 발송
4. sms_logs 테이블에 실패 로그

**알림:**

```
[긴급] SMS 발송 실패
Job ID: {job_id}
Phone: {phone_number}
Error: {error_message}
```

---

### 6.2 잘못된 전화번호

**시나리오:**

- 형식 오류
- 존재하지 않는 번호

**에러 코드:** `E-SMS-002`

**사용자 메시지:**

```
(결제 시 전화번호 검증으로 예방)
```

**처리 방안:**

1. 결제 시 전화번호 형식 검증
2. SMS 발송 실패 시 로그 저장
3. 관리자 확인 후 수동 처리

---

## 7. 결과 조회 에러

### 7.1 전화번호 인증 실패

**시나리오:**

- 전화번호 불일치
- 3회 실패

**에러 코드:** `E-AUTH-001`

**사용자 메시지:**

```
전화번호가 일치하지 않습니다.
결제 시 입력한 전화번호를 확인해주세요.
(남은 시도: 2회)
```

**처리 방안:**

1. phone_verification_attempts 테이블에 로그
2. 3회 실패 시 IP 차단 (1시간)
3. 차단 메시지 표시

**차단 메시지:**

```
인증 시도 횟수를 초과했습니다.
1시간 후 다시 시도하거나 고객센터로 문의해주세요.
```

---

### 7.2 Job 만료

**시나리오:**

- 24시간 경과
- 이미 삭제됨

**에러 코드:** `E-AUTH-002`

**사용자 메시지:**

```
결과가 만료되었습니다. (24시간 경과)
새로운 서비스를 이용해주세요.
```

**처리 방안:**

1. 410 Gone 상태 코드 반환
2. 재구매 유도 (할인 쿠폰 제공 - 향후)

---

### 7.3 파일 없음

**시나리오:**

- S3 파일 삭제됨
- 생성 실패

**에러 코드:** `E-FILE-001`

**사용자 메시지:**

```
결과 파일을 찾을 수 없습니다.
고객센터로 문의해주세요.
```

**처리 방안:**

1. 관리자 알림 (긴급)
2. 수동 확인 및 복구
3. 복구 불가 시 환불

---

## 8. 시스템 에러

### 8.1 데이터베이스 연결 실패

**시나리오:**

- DB 서버 다운
- 네트워크 오류
- 연결 풀 고갈

**에러 코드:** `E-SYS-001`

**사용자 메시지:**

```
일시적인 서버 오류입니다.
잠시 후 다시 시도해주세요.
```

**처리 방안:**

1. 자동 재연결 시도
2. Health Check 실패 → Load Balancer에서 제외
3. 관리자 알림 (긴급)
4. 백업 DB로 전환 (선택사항)

---

### 8.2 메모리 부족

**시나리오:**

- 대용량 이미지 처리
- 메모리 누수

**에러 코드:** `E-SYS-002`

**사용자 메시지:**

```
서버 과부하입니다.
잠시 후 다시 시도해주세요.
```

**처리 방안:**

1. 프로세스 재시작
2. 이미지 크기 제한 강화
3. 메모리 모니터링 강화

---

### 8.3 외부 API 전체 장애

**시나리오:**

- Replicate, OpenAI, CoolSMS 모두 장애

**에러 코드:** `E-SYS-003`

**사용자 메시지:**

```
서비스 점검 중입니다.
복구 후 SMS로 안내드리겠습니다.
```

**처리 방안:**

1. 서비스 일시 중단
2. 점검 페이지 표시
3. 대기 중인 Job 큐에 저장
4. 복구 후 순차 처리

---

## 9. 모니터링 및 알림

### 9.1 에러 레벨

| Level    | 설명                      | 알림                |
| -------- | ------------------------- | ------------------- |
| DEBUG    | 디버깅 정보               | 없음                |
| INFO     | 일반 정보                 | 없음                |
| WARNING  | 경고 (서비스 계속)        | 로그만              |
| ERROR    | 에러 (일부 실패)          | Slack               |
| CRITICAL | 치명적 에러 (서비스 중단) | Slack + Email + SMS |

### 9.2 알림 조건

**즉시 알림:**

- 결제 금액 불일치
- DB 연결 실패
- 외부 API 전체 장애
- 보안 사고

**집계 알림 (1시간 단위):**

- 에러율 > 5%
- AI 생성 실패율 > 10%
- SMS 발송 실패율 > 5%

### 9.3 대시보드

**실시간 모니터링:**

- 현재 처리 중인 Job 수
- 에러율 (1시간, 24시간)
- API 응답 시간
- 외부 API 상태

**일일 리포트:**

- 총 거래 건수
- 성공/실패 건수
- 평균 처리 시간
- 주요 에러 Top 10
